$(document).ready(function(){process.calculDiscount(),process.dropzone(),process.datepickers(),$(".validDeal").click(function(a){validator=step.validStep3(),validator&&$("#addDealProcess").submit()}),$(".coupon_choose").click(function(){$(".coupon_choose").removeClass("btn-info"),$(this).addClass("btn-info"),$("#coupons").val($(this).attr("num"))}),$("#validite").change(function(){"4"==$(this).val()?$("#date_valid_group").show():$("#date_valid_group").hide()}),$(".categorieChoosed").click(function(a){a.preventDefault(),$(".categoryChoosed").html($(this).html()).attr("category_id",$(this).attr("category_id")),$("#category_id").val($(this).attr("category_id")),$(".subCategoriesChoosed").show(),$(".subCategoryError").hide(),$(".subCategories").html(""),$.ajax({url:$("#base_url").val()+"ajax/getSubCategories/"+$(this).attr("category_id"),dataType:"json"}).complete(function(a){if(void 0!=a.responseJSON&&void 0!=a.responseJSON[0]){for(key in a.responseJSON)$(".subCategories").append('<li><a href="#" subcategory_id="'+a.responseJSON[key].id+'"><i class="fa fa-arrow-right"></i> '+a.responseJSON[key].name+"</a></li>");step.goStep2()}else $(".subCategoryError").show()}).error(function(){$(".subCategoryError").show()})}),$(".changeCategory").click(function(){step.returnStep1()}),$(".modifyDeal").click(function(){step.returnStep2()})}),step={returnStep1:function(){$(".step_2").animate({width:"toggle"},350,"linear",function(){$(".step_1").show()})},goStep2:function(){$(".subCategories li a").unbind("click"),$(".subCategories li a").click(function(a){a.preventDefault(),$(".subCategoryChoosed").html($(this).html()),$("#subcategory_id").val($(this).attr("subcategory_id")),process.getCovers($(".categoryChoosed").attr("category_id")),$(".step_1").animate({width:"toggle"},350,"linear",function(){"boutique"==$("#type_deal").val()?$(".step_3").show():($(".step_2").show(),process.loadTinymce(),$(".goStep3").unbind("click"),$(".goStep3").click(function(){step.goStep3()}))})})},returnStep2:function(){$(".step_3").animate({width:"toggle"},350,"linear",function(){$(".step_2").show(),process.loadTinymce()})},validStep2:function(){return $(".alert").hide(),$("input, textarea").css("border-color",""),error=!1,title=$("#title"),start=$("#start"),start_submit=$('input[name="start_submit"]'),end=$("#end"),end_submit=$('input[name="end_submit"]'),price_base=$("#price_base"),price_promo=$("#price_promo"),promo_amount=$("#promo_amount"),promo_discount=$("#promo_discount"),excerpt=$("#excerpt"),content=$("#content").val(),date_valid=$("#date_valid"),(""==title.val()||title.val().length<=5||title.val().length>25)&&(error=!0,title.css("border-color","red"),title.next(".alert").show()),""!=start_submit.val()&&isValidDate(start_submit.val())||(error=!0,start.css("border-color","red"),start_submit.parent().next(".alert").show()),""!=end_submit.val()&&isValidDate(end_submit.val())||(error=!0,end.css("border-color","red"),end_submit.parent().next(".alert").show()),""!=price_base.val()&&$.isNumeric(price_base.val())||(error=!0,price_base.css("border-color","red"),price_base.parent().next(".alert").show()),""!=price_promo.val()&&$.isNumeric(price_promo.val())||(error=!0,price_promo.css("border-color","red"),price_promo.parent().next(".alert").show()),""!=promo_amount.val()&&$.isNumeric(promo_amount.val())||(error=!0,promo_amount.css("border-color","red"),promo_amount.parent().next(".alert").show()),""!=promo_discount.val()&&$.isNumeric(promo_discount.val())||(error=!0,promo_discount.css("border-color","red"),promo_discount.parent().next(".alert").show()),(""==excerpt.val()||excerpt.val().length<=5||excerpt.val().length>85)&&(error=!0,excerpt.css("border-color","red"),excerpt.next(".alert").show()),"4"==$("#validite").val()&&""==date_valid.val()&&(error=!0,date_valid.css("border-color","red"),date_valid.parent().next(".alert").show()),(""==process.getTinymce()||process.getTinymce()=="Description complète de mon "+$("#type_deal_full").val()+"..."||parseInt($(".mce-wordcount").html().replace("Mots : ",""))<100)&&(error=!0,$("#content").css("border-color","red"),$(".alert",$("#content").parent()).show()),""==$("#cover").val()&&(error=!0,$(".errorCover").show()),1!=error},goStep3:function(){if(void 0!=$("#pro_id").val()&&""!=$("#pro_id").val())return void $("#addDealProcess").submit();validation=step.validStep2(),1==validation&&$(".step_2").animate({width:"toggle"},350,"linear",function(){process.addressAutocomplete(),$(".step_3").show()})},validStep3:function(){return $(".alert").hide(),$("input, textarea").css("border-color",""),error=!1,company=$("#company"),siret=$("#siret"),name_dealer=$("#name_dealer"),address=$("#address"),zipcode=$("#zipcode"),city=$("#city"),phone=$("#phone"),email=$("#email"),legal=$("#legal"),(""==company.val()||company.val().length<=3||company.val().length>=30)&&(error=!0,company.css("border-color","red"),company.parent().next(".alert").show()),(""==siret.val()||siret.val().length<=9||siret.val().length>=14||!$.isNumeric(siret.val()))&&(error=!0,siret.css("border-color","red"),siret.parent().next(".alert").show()),(""==name_dealer.val()||name_dealer.val().length<=3)&&(error=!0,name_dealer.css("border-color","red"),name_dealer.parent().next(".alert").show()),(""==address.val()||address.val().length<=5)&&(error=!0,address.css("border-color","red"),address.parent().next(".alert").show()),(""==city.val()||city.val().length<=2)&&(error=!0,city.css("border-color","red"),city.parent().next(".alert").show()),""!=zipcode.val()&&5==zipcode.val().length&&$.isNumeric(zipcode.val())||(error=!0,zipcode.css("border-color","red"),zipcode.parent().next(".alert").show()),""!=phone.val()&&10==phone.val().length&&$.isNumeric(phone.val())||(error=!0,phone.css("border-color","red"),phone.parent().next(".alert").show()),(""==email.val()||email.val().length<=3||!validateEmail(email.val()))&&(error=!0,email.css("border-color","red"),email.parent().next(".alert").show()),0==legal.is(":checked")&&(error=!0,$(".alert",legal.parent()).show()),1!=error}},process={datepickers:function(){configFR={monthsFull:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],monthsShort:["Jan","Fev","Mar","Avr","Mai","Juin","Juil","Aou","Sep","Oct","Nov","Dec"],weekdaysFull:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],weekdaysShort:["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],today:"Aujourd'hui",clear:"Effacer",close:"Fermer",firstDay:1,format:"dd/mm/yyyy",formatSubmit:"dd/mm/yyyy",labelMonthNext:"Mois suivant",labelMonthPrev:"Mois précédent",labelMonthSelect:"Sélectionner un mois",labelYearSelect:"Sélectionner une année"};var a=$("#start").pickadate(configFR),b=a.pickadate("picker"),c=$("#end").pickadate(configFR),d=c.pickadate("picker");$("#date_valid").pickadate(configFR),b.get("value")&&d.set("min",b.get("select")),d.get("value")&&b.set("max",d.get("select")),"bon-plan"!=$("#type_deal").val()&&(b.on("set",function(a){if(a.select){dateExploded=$("#start").val().split("/");var c=new Date(dateExploded[2]+"-"+dateExploded[1]+"-"+dateExploded[0]);c.setDate(c.getDate()+60),d.set("min",b.get("select")),d.set("max",c)}else"clear"in a&&(d.set("min",!1),d.set("max",!1))}),d.on("set",function(a){if(a.select){dateExploded=$("#end").val().split("/");var c=new Date(dateExploded[2]+"-"+dateExploded[1]+"-"+dateExploded[0]);c.setDate(c.getDate()-60),b.set("max",d.get("select")),b.set("min",c)}else"clear"in a&&(b.set("max",!1),b.set("min",!1))}))},calculDiscount:function(){$("#price_promo, #price_base").change(function(){prixBase=$("#price_base").val(),prixPromo=$("#price_promo").val(),""!=prixBase&&$.isNumeric(prixBase)&&""!=prixPromo&&$.isNumeric(prixPromo)&&($("#promo_amount").val(prixBase-prixPromo),$("#promo_discount").val(Math.abs(parseInt((prixPromo-prixBase)/prixBase*100))),process.calculComission())}),$("#promo_amount").change(function(){prixBase=$("#price_base").val(),promoAmount=$("#promo_amount").val(),""!=prixBase&&$.isNumeric(prixBase)&&""!=promoAmount&&$.isNumeric(promoAmount)&&($("#price_promo").val(prixBase-promoAmount),prixPromo=$("#price_promo").val(),$("#promo_discount").val(Math.abs(parseInt((prixPromo-prixBase)/prixBase*100))),process.calculComission())}),$("#promo_discount").change(function(){prixBase=$("#price_base").val(),promoDiscount=$("#promo_discount").val(),""!=prixBase&&$.isNumeric(prixBase)&&""!=promoDiscount&&$.isNumeric(promoDiscount)&&($("#promo_discount").val(Math.abs(promoDiscount)),promoDiscount=$("#promo_discount").val(),$("#price_promo").val(parseInt(prixBase-prixBase*parseInt(promoDiscount)/100)),prixPromo=$("#price_promo").val(),$("#promo_amount").val(prixBase-prixPromo),process.calculComission())}),"bon-plan"==$("#type_deal").val()&&($("#price_base").change(function(){process.calculComission()}),$("#start").change(function(){process.calculComission()}),$("#end").change(function(){process.calculComission()}))},calculComission:function(){if($("#commission").hide(),$("#coupon").hide(),$("#plan").hide(),"deal"==$("#type_deal").val())promoPrice=parseInt($("#price_promo").val()),promoPrice>0&&""!=promoPrice?($("#commission h4:eq(2)").html(parseInt(parseInt(promoPrice)-.2*parseInt(promoPrice))+$('#currency').val()),$("#commission").slideDown()):$("#commission").hide();else if("bon-de-réduction"==$("#type_deal").val())promoPrice=parseInt($("#price_promo").val()),promoPrice>0&&""!=promoPrice?($("#coupon a:eq(0) span").html(parseInt(.005*parseInt(promoPrice)*50)+$('#currency').val()),$("#coupon a:eq(1) span").html(parseInt(.005*parseInt(promoPrice)*100)+$('#currency').val()),$("#coupon a:eq(2) span").html(parseInt(.005*parseInt(promoPrice)*500)+$('#currency').val()),$("#coupon").slideDown()):$("#coupon").hide();else if(price=parseInt($("#price_base").val()),price>0&&""!=price&&""!=$("#start").val()&&""!=$("#end").val()){a=$("#start").val().split("/");var a=new Date(a[2]+"-"+a[1]+"-"+a[0]);b=$("#end").val().split("/");var b=new Date(b[2]+"-"+b[1]+"-"+b[0]);WNbJours=b.getTime()-a.getTime(),diffDays=Math.ceil(WNbJours/864e5),$("#plan h4:eq(2)").html(parseInt(.01*parseInt(price)*diffDays)+$('#currency').val()),$("#plan").slideDown()}else $("#plan").hide()},getCovers:function(a){$(".loadingCoversError").hide(),$(".covers").html(""),$.ajax({url:$("#base_url").val()+"ajax/loadImagesCategory/"+a,dataType:"json"}).complete(function(b){if(void 0!=b.responseJSON&&"false"!=b.responseJSON){for(key in b.responseJSON)$(".covers").append('<div class="col-md-3 mb-5 text-center" '+(1==ismobile?"":'style="height: 125px;"')+'><a href="#" class="coverToChoose" image="'+a+"/"+b.responseJSON[key]+'"><img src="'+$("#base_url").val()+"assets/images/categories/"+a+"/"+b.responseJSON[key]+'" '+(1==ismobile?"":'style="max-height: 125px;"')+" /></div>");$(".covers").append('<div class="clear clearfix">&nbsp;</div>'),process.chooseCover()}else $(".loadingCoversError").show()}).error(function(){$(".loadingCoversError").show()})},chooseCover:function(){$(".coverToChoose").unbind("click"),$(".coverToChoose").click(function(a){a.preventDefault(),$(".coverToChoose img").css("border",""),$("img",this).css("border","3px solid lightgreen"),$("#cover").val($(this).attr("image")),$("#chooseCover").modal("hide")})},addressAutocomplete:function(){var a=document.getElementById("address");autocomplete=new google.maps.places.SearchBox(a),autocomplete.addListener("places_changed",function(){var a=autocomplete.getPlaces();if(myAdress=a[0].address_components,void 0!=a[0]&&void 0!=a[0].types&&void 0!=a[0].types[0]&&"street_address"==a[0].types[0])for(key in myAdress)void 0!=myAdress[key].types&&("postal_code"==myAdress[key].types[0]&&$("#zipcode").val(myAdress[key].long_name),"street_number"==myAdress[key].types[0]&&$("#address").val(myAdress[key].long_name),"route"==myAdress[key].types[0]&&$("#address").val($("#address").val()+" "+myAdress[key].long_name));lat=a[0].geometry.location.lat(),lng=a[0].geometry.location.lng(),null!=lat&&null!=lng&&($("#latitude").val(lat),$("#longitude").val(lng))})},loadTinymce:function(){tinymce.init({selector:"#content",menubar:!1,language:"fr_FR",plugins:["advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker","searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking","save table contextmenu directionality emoticons template paste textcolor"],toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | preview "})},getTinymce:function(){return tinymce.activeEditor.getContent({format:"text"})},dropzone:function(){Dropzone.autoDiscover=!1,$("#addMyPics").dropzone({url:$("#base_url").val()+"ajax/addPics/",addRemoveLinks:!0,dictRemoveFile:"Supprimer",dictCancelUpload:"Annuler",dictInvalidFileType:"Fichier non autorisé",dictFileTooBig:"Cette photo est trop grande. Maximum autorisé : {{maxFilesize}}Mb",maxFilesize:10,maxFiles:20,acceptedFiles:"image/*",dictDefaultMessage:'<h3 class="text-center"><span class="font-lg"><i class="fa fa-photo"></i> Glissez vos photos .png .jpg .gif <span class="font-xs"></span></span><h3>&nbsp&nbsp<h4 class="display-inline"><em> (Ou cliquez ici)</em></h4>',dictResponseError:"Erreur durant l'envoi de vos photos",removedfile:function(a){$.ajax({url:$("#base_url").val()+"ajax/deletePics/",data:{name:a.name},dataType:"json",method:"post"}).complete(function(b){void 0!=b.responseJSON&&"false"!=b.responseJSON&&$(a.previewElement).remove()}).error(function(){})}})}};